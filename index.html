<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Metazoa AI – Détection d'animaux</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,100..900;1,9..144,100..900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
      #preview {
        max-width: 300px;
        display: none;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="glass-container">
      <img
        src="assets/flying_duck.png"
        alt="Flying Duck"
        class="duck-container"
      />
      <header>
        <h1>Metazoa AI</h1>
        <p>Détection automatique d'animaux via IA</p>
      </header>

      <main>
        <form id="upload-form">
          <label for="file">Choisissez une image :</label><br />
          <input type="file" id="file" accept="image/*" required /><br />
          <button type="submit" id="runModel">Analyser</button>
        </form>

        <img
          id="preview"
          src=""
          alt="Aperçu de l'image"
          class="image-preview"
        />

        <div id="result"></div>
      </main>

      <footer>&copy; 2025 Metazoa AI — Tous droits réservés.</footer>
    </div>

    <script>
      const CLASSES = ["Lynx", "Tortue", "Salamandre"];
      const inputFile = document.getElementById("file");
      const preview = document.getElementById("preview");
      const resultDiv = document.getElementById("result");
      const uploadForm = document.getElementById("upload-form");

      inputFile.addEventListener("change", () => {
        const file = inputFile.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function () {
            preview.src = reader.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          preview.style.display = "none";
          preview.src = "";
        }
      });

      uploadForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        if (inputFile.files.length === 0) {
          alert("Choisis une image !");
          return;
        }

        const file = inputFile.files[0];
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();
        console.log("Image chargée :", img);

        const inputTensor = await preprocessImage(img);
        // showProcessedImage(inputTensor.data);
        const session = await ort.InferenceSession.create("my_model.onnx");

        const feeds = {};
        feeds[session.inputNames[0]] = inputTensor;

        const results = await session.run(feeds);
        const output = results[session.outputNames[0]];
        console.log("Logits bruts :", output.data);

        let maxIndex = 0;
        let maxVal = output.data[0];
        for (let i = 1; i < output.data.length; i++) {
          if (output.data[i] > maxVal) {
            maxVal = output.data[i];
            maxIndex = i;
          }
        }

        resultDiv.innerText = "Prédiction : " + CLASSES[maxIndex];
      });

      async function preprocessImage(imageElement) {
        const size = 128;
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = size;
        canvas.height = size;
        ctx.drawImage(imageElement, 0, 0, size, size);

        const imageData = ctx.getImageData(0, 0, size, size);
        const data = imageData.data;
        const float32Data = new Float32Array(size * size * 3);

        for (let i = 0; i < size * size; i++) {
          const r = data[i * 4] / 255; // Normalise en [0,1]
          const g = data[i * 4 + 1] / 255;
          const b = data[i * 4 + 2] / 255;

          // Normalisation avec moyennes/écarts types ImageNet (vérifie si ok pour ton modèle)
          float32Data[i] = (r - 0.485) / 0.229; // canal R
          float32Data[i + size * size] = (g - 0.456) / 0.224; // canal G
          float32Data[i + 2 * size * size] = (b - 0.406) / 0.225; // canal B
        }

        console.log(
          "Moyenne pixels normalisés :",
          float32Data.reduce((a, b) => a + b) / float32Data.length
        );

        // Crée le tenseur ONNX avec la bonne forme
        return new ort.Tensor("float32", float32Data, [1, 3, size, size]);
      }

      function showProcessedImage(float32Data, size = 128) {
        const canvas = document.createElement("canvas");
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext("2d");
        const imageData = ctx.createImageData(size, size);
        for (let i = 0; i < size * size; i++) {
          imageData.data[i * 4] = (float32Data[i] * 0.229 + 0.485) * 255; // R dénormalisé
          imageData.data[i * 4 + 1] =
            (float32Data[i + size * size] * 0.224 + 0.456) * 255; // G
          imageData.data[i * 4 + 2] =
            (float32Data[i + 2 * size * size] * 0.225 + 0.406) * 255; // B
          imageData.data[i * 4 + 3] = 255; // Alpha
        }
        ctx.putImageData(imageData, 0, 0);
        document.body.appendChild(canvas);
      }
    </script>
  </body>
</html>
